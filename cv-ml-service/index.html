<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV/ML Service - Real-time Video Processing</title>
    <link rel="stylesheet" href="styles.css">
    
    <!-- TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0"></script>
    
    <!-- BlazeFace for Face Detection -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@0.0.7"></script>
    
    <!-- Face Mesh -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/facemesh@0.0.5"></script>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">ƒêang t·∫£i AI Models...</div>
        <div class="loading-subtext">Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t</div>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="error-message">
        <p id="errorText"></p>
    </div>

    <!-- Header -->
    <header class="header">
        <h1>üé• CV/ML Service - Real-time Video Processing</h1>
        <p>X·ª≠ l√Ω ·∫£nh th·ªùi gian th·ª±c v·ªõi TensorFlow.js v√† Computer Vision</p>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Video Section -->
        <div class="video-section">
            <!-- Video Display -->
            <div class="video-container">
                <div class="video-wrapper">
                    <canvas id="canvas_ket_qua"></canvas>
                    
                    <!-- Status Badge -->
                    <div class="status-badge">
                        <div class="status-indicator"></div>
                        <span id="statusText">S·∫µn s√†ng</span>
                    </div>
                    
                    <!-- FPS Badge -->
                    <div class="fps-badge">
                        <span>FPS:</span>
                        <span class="fps-value" id="fpsDisplay">0</span>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <button id="startBtn" class="btn btn-success">
                    ‚ñ∂ B·∫Øt ƒë·∫ßu
                </button>
                <button id="stopBtn" class="btn btn-danger" disabled>
                    ‚è∏ D·ª´ng
                </button>
                <button id="resetFiltersBtn" class="btn btn-primary">
                    üîÑ Reset Filters
                </button>
            </div>

            <!-- Info Panel -->
            <div class="info-panel">
                <div class="info-item">
                    <span class="info-label">Resolution:</span>
                    <span class="info-value" id="resolution">640x480</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Active Filters:</span>
                    <span class="info-value" id="activeFiltersCount">0</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Processing Status:</span>
                    <span class="info-value" id="processingStatus">Stopped</span>
                </div>
            </div>
        </div>

        <!-- Filter Panel -->
        <aside class="filter-panel">
            <h2>üé® B·ªô l·ªçc</h2>

            <!-- Basic Filters -->
            <div class="filter-category">
                <h3>Filters C∆° b·∫£n</h3>
                
                <div class="filter-item" data-filter="grayscale">
                    <div class="filter-header">
                        <span class="filter-name">Grayscale</span>
                        <div class="filter-toggle"></div>
                    </div>
                    <div class="filter-description">
                        Chuy·ªÉn ƒë·ªïi video sang ƒëen tr·∫Øng
                    </div>
                </div>

                <div class="filter-item" data-filter="blur">
                    <div class="filter-header">
                        <span class="filter-name">Blur</span>
                        <div class="filter-toggle"></div>
                    </div>
                    <div class="filter-description">
                        L√†m m·ªù video ƒë·ªÉ t·∫°o hi·ªáu ·ª©ng ngh·ªá thu·∫≠t
                    </div>
                </div>
            </div>

            <!-- AI Filters -->
            <div class="filter-category">
                <h3>AI Filters (TensorFlow.js)</h3>
                
                <div class="filter-item" data-filter="face_detection">
                    <div class="filter-header">
                        <span class="filter-name">Face Detection</span>
                        <div class="filter-toggle"></div>
                    </div>
                    <div class="filter-description">
                        Ph√°t hi·ªán v√† ƒë√°nh d·∫•u khu√¥n m·∫∑t trong video
                    </div>
                </div>

                <div class="filter-item" data-filter="face_mesh">
                    <div class="filter-header">
                        <span class="filter-name">Face Mesh</span>
                        <div class="filter-toggle"></div>
                    </div>
                    <div class="filter-description">
                        Hi·ªÉn th·ªã l∆∞·ªõi c√°c ƒëi·ªÉm m·ªëc tr√™n khu√¥n m·∫∑t
                    </div>
                </div>

                <div class="filter-item" data-filter="sunglasses">
                    <div class="filter-header">
                        <span class="filter-name">üï∂Ô∏è Sunglasses AR</span>
                        <div class="filter-toggle"></div>
                    </div>
                    <div class="filter-description">
                        Th√™m k√≠nh r√¢m ·∫£o s·ª≠ d·ª•ng AR
                    </div>
                </div>
            </div>

            <!-- Instructions -->
            <div style="margin-top: 2rem; padding: 1rem; background: rgba(74, 144, 226, 0.1); border-radius: 8px; border-left: 3px solid var(--primary-color);">
                <h3 style="font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--primary-color);">üìñ H∆∞·ªõng d·∫´n</h3>
                <ul style="font-size: 0.85rem; color: var(--text-muted); padding-left: 1.2rem; line-height: 1.6;">
                    <li>Nh·∫•n "B·∫Øt ƒë·∫ßu" ƒë·ªÉ kh·ªüi ƒë·ªông camera</li>
                    <li>Ch·ªçn filters mu·ªën √°p d·ª•ng</li>
                    <li>C√≥ th·ªÉ k·∫øt h·ª£p nhi·ªÅu filters c√πng l√∫c</li>
                    <li>FPS t·ªëi thi·ªÉu: 20 FPS</li>
                </ul>
            </div>
        </aside>
    </div>

    <!-- Main Application Script -->
    <script type="module">
        import { VideoProcessor } from './videoProcessor.js';
        import { FILTER_TYPES } from './constants.js';

        // Initialize Application
        class App {
            constructor() {
                this.videoProcessor = null;
                this.filterManager = null;
                this.isInitialized = false;
                
                this.initializeElements();
                this.attachEventListeners();
                this.init();
            }

            initializeElements() {
                // Buttons
                this.startBtn = document.getElementById('startBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.resetFiltersBtn = document.getElementById('resetFiltersBtn');

                // Display elements
                this.fpsDisplay = document.getElementById('fpsDisplay');
                this.statusText = document.getElementById('statusText');
                this.activeFiltersCount = document.getElementById('activeFiltersCount');
                this.processingStatus = document.getElementById('processingStatus');
                this.loadingOverlay = document.getElementById('loadingOverlay');
                this.errorMessage = document.getElementById('errorMessage');
                this.errorText = document.getElementById('errorText');

                // Filter items
                this.filterItems = document.querySelectorAll('.filter-item');
            }

            attachEventListeners() {
                // Control buttons
                this.startBtn.addEventListener('click', () => this.start());
                this.stopBtn.addEventListener('click', () => this.stop());
                this.resetFiltersBtn.addEventListener('click', () => this.resetFilters());

                // Filter items
                this.filterItems.forEach(item => {
                    item.addEventListener('click', () => {
                        const filterType = item.getAttribute('data-filter');
                        this.toggleFilter(filterType, item);
                    });
                });
            }

            async init() {
                try {
                    this.showLoading(true);
                    
                    // Create video processor
                    this.videoProcessor = new VideoProcessor();
                    
                    // Set callbacks
                    this.videoProcessor.onFpsUpdate = (fps) => this.updateFps(fps);
                    this.videoProcessor.onError = (error) => this.showError(error);
                    this.videoProcessor.onReady = () => this.onReady();

                    // Initialize
                    await this.videoProcessor.initialize();
                    
                    // Get filter manager
                    this.filterManager = this.videoProcessor.getFilterManager();
                    
                    this.isInitialized = true;
                    this.showLoading(false);
                    
                    console.log('‚úì Application initialized successfully!');
                } catch (error) {
                    this.showLoading(false);
                    this.showError(error.message);
                    console.error('Initialization failed:', error);
                }
            }

            start() {
                if (!this.isInitialized) {
                    this.showError('·ª®ng d·ª•ng ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o');
                    return;
                }

                this.videoProcessor.start();
                this.startBtn.disabled = true;
                this.stopBtn.disabled = false;
                this.processingStatus.textContent = 'Running';
                this.statusText.textContent = 'ƒêang x·ª≠ l√Ω';
                console.log('Video processing started');
            }

            stop() {
                this.videoProcessor.stop();
                this.startBtn.disabled = false;
                this.stopBtn.disabled = true;
                this.processingStatus.textContent = 'Stopped';
                this.statusText.textContent = 'ƒê√£ d·ª´ng';
                console.log('Video processing stopped');
            }

            toggleFilter(filterType, element) {
                if (!this.filterManager) {
                    return;
                }

                this.filterManager.toggleFilter(filterType);
                element.classList.toggle('active');
                
                this.updateActiveFiltersCount();
                
                const isActive = element.classList.contains('active');
                console.log(`Filter ${filterType}: ${isActive ? 'enabled' : 'disabled'}`);
            }

            resetFilters() {
                if (!this.filterManager) {
                    return;
                }

                this.filterManager.clearAllFilters();
                this.filterItems.forEach(item => item.classList.remove('active'));
                this.updateActiveFiltersCount();
                console.log('All filters reset');
            }

            updateFps(fps) {
                this.fpsDisplay.textContent = fps;
            }

            updateActiveFiltersCount() {
                if (!this.filterManager) {
                    return;
                }

                const count = this.filterManager.getActiveFilters().size;
                this.activeFiltersCount.textContent = count;
            }

            showLoading(show) {
                if (show) {
                    this.loadingOverlay.classList.remove('hidden');
                } else {
                    this.loadingOverlay.classList.add('hidden');
                }
            }

            showError(message) {
                this.errorText.textContent = message;
                this.errorMessage.classList.add('show');
                
                setTimeout(() => {
                    this.errorMessage.classList.remove('show');
                }, 5000);
            }

            onReady() {
                console.log('Video processor ready!');
            }
        }

        // Start application when DOM is loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                new App();
            });
        } else {
            new App();
        }
    </script>
</body>
</html>

